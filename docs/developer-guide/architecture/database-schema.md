# üóÑÔ∏è **SCHEMA DO BANCO DE DADOS - SISTEMA LANCEI ESSA**

**Data de Cria√ß√£o:** 29/01/2025  
**√öltima Atualiza√ß√£o:** 29/01/2025  
**Vers√£o:** 1.0  
**Respons√°vel:** AI Assistant  
**Status:** ‚úÖ Ativo

---

## üéØ **OBJETIVO**

Este documento detalha o schema do banco de dados do Sistema Lancei Essa, incluindo tabelas, relacionamentos, √≠ndices e estrat√©gias de migra√ß√£o.

---

## üìä **DIAGRAMA ENTIDADE-RELACIONAMENTO**

```mermaid
erDiagram
    User ||--o{ YouTubeToken : has
    User ||--o{ Guest : creates
    User ||--o{ AuditLog : triggers
    YouTubeToken ||--|| YouTubeChannel : connects

    User {
        string id PK
        string email UK
        string name
        string googleId UK
        datetime createdAt
        datetime updatedAt
    }

    YouTubeToken {
        string id PK
        string userId FK
        string accessToken
        string refreshToken
        datetime expiresAt
        string scope
        datetime createdAt
        datetime updatedAt
    }

    YouTubeChannel {
        string id PK
        string tokenId FK
        string channelId UK
        string title
        string description
        int subscriberCount
        int videoCount
        int viewCount
        datetime createdAt
        datetime updatedAt
    }

    Guest {
        string id PK
        string userId FK
        string name
        string email
        string status
        json metadata
        datetime createdAt
        datetime updatedAt
    }

    AuditLog {
        string id PK
        string userId FK
        string action
        string resource
        json details
        string ipAddress
        string userAgent
        datetime createdAt
    }
```

---

## üìã **TABELAS DETALHADAS**

### üë§ **Users**
Armazena informa√ß√µes dos usu√°rios autenticados via Google.

```sql
CREATE TABLE users (
    id VARCHAR(36) PRIMARY KEY DEFAULT (uuid()),
    email VARCHAR(255) NOT NULL UNIQUE,
    name VARCHAR(255) NOT NULL,
    google_id VARCHAR(255) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_users_email (email),
    INDEX idx_users_google_id (google_id),
    INDEX idx_users_created_at (created_at)
);
```

#### **Campos:**
| Campo | Tipo | Nulo | Descri√ß√£o |
|-------|------|------|-----------|
| `id` | VARCHAR(36) | ‚ùå | UUID √∫nico do usu√°rio |
| `email` | VARCHAR(255) | ‚ùå | Email do Google (√∫nico) |
| `name` | VARCHAR(255) | ‚ùå | Nome completo do usu√°rio |
| `google_id` | VARCHAR(255) | ‚ùå | ID √∫nico do Google (√∫nico) |
| `created_at` | TIMESTAMP | ‚ùå | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | ‚ùå | √öltima atualiza√ß√£o |

#### **Regras de Neg√≥cio:**
- Email deve ser v√°lido e √∫nico
- Google ID deve ser √∫nico
- Nome √© obrigat√≥rio
- Soft delete n√£o implementado (hard delete)

### üîë **YouTube Tokens**
Armazena tokens OAuth2 para acesso ao YouTube Analytics.

```sql
CREATE TABLE youtube_tokens (
    id VARCHAR(36) PRIMARY KEY DEFAULT (uuid()),
    user_id VARCHAR(36) NOT NULL,
    access_token TEXT NOT NULL,
    refresh_token TEXT NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    scope VARCHAR(500) DEFAULT 'https://www.googleapis.com/auth/youtube.readonly',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_youtube_tokens_user_id (user_id),
    INDEX idx_youtube_tokens_expires_at (expires_at)
);
```

#### **Campos:**
| Campo | Tipo | Nulo | Descri√ß√£o |
|-------|------|------|-----------|
| `id` | VARCHAR(36) | ‚ùå | UUID √∫nico do token |
| `user_id` | VARCHAR(36) | ‚ùå | FK para users.id |
| `access_token` | TEXT | ‚ùå | Token de acesso (criptografado) |
| `refresh_token` | TEXT | ‚ùå | Token de refresh (criptografado) |
| `expires_at` | TIMESTAMP | ‚ùå | Expira√ß√£o do access_token |
| `scope` | VARCHAR(500) | ‚úÖ | Escopo das permiss√µes |
| `created_at` | TIMESTAMP | ‚ùå | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | ‚ùå | √öltima atualiza√ß√£o |

#### **Seguran√ßa:**
- Tokens s√£o criptografados antes do storage
- Refresh autom√°tico via cronjob
- Expira√ß√£o monitorada

### üì∫ **YouTube Channels**
Cache dos dados do canal do YouTube.

```sql
CREATE TABLE youtube_channels (
    id VARCHAR(36) PRIMARY KEY DEFAULT (uuid()),
    token_id VARCHAR(36) NOT NULL,
    channel_id VARCHAR(255) NOT NULL UNIQUE,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    subscriber_count INT DEFAULT 0,
    video_count INT DEFAULT 0,
    view_count BIGINT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (token_id) REFERENCES youtube_tokens(id) ON DELETE CASCADE,
    INDEX idx_youtube_channels_token_id (token_id),
    INDEX idx_youtube_channels_channel_id (channel_id),
    INDEX idx_youtube_channels_updated_at (updated_at)
);
```

#### **Campos:**
| Campo | Tipo | Nulo | Descri√ß√£o |
|-------|------|------|-----------|
| `id` | VARCHAR(36) | ‚ùå | UUID √∫nico do registro |
| `token_id` | VARCHAR(36) | ‚ùå | FK para youtube_tokens.id |
| `channel_id` | VARCHAR(255) | ‚ùå | ID √∫nico do canal no YouTube |
| `title` | VARCHAR(255) | ‚ùå | Nome do canal |
| `description` | TEXT | ‚úÖ | Descri√ß√£o do canal |
| `subscriber_count` | INT | ‚úÖ | N√∫mero de inscritos |
| `video_count` | INT | ‚úÖ | N√∫mero de v√≠deos |
| `view_count` | BIGINT | ‚úÖ | Total de visualiza√ß√µes |
| `created_at` | TIMESTAMP | ‚ùå | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | ‚ùå | √öltima sincroniza√ß√£o |

#### **Cache Strategy:**
- Atualiza√ß√£o a cada 1 hora
- Invalida√ß√£o manual via endpoint
- TTL baseado em `updated_at`

### üë• **Guests**
Sistema de gerenciamento de convidados.

```sql
CREATE TABLE guests (
    id VARCHAR(36) PRIMARY KEY DEFAULT (uuid()),
    user_id VARCHAR(36) NOT NULL,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255),
    status ENUM('pending', 'confirmed', 'cancelled') DEFAULT 'pending',
    metadata JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_guests_user_id (user_id),
    INDEX idx_guests_status (status),
    INDEX idx_guests_email (email),
    INDEX idx_guests_created_at (created_at)
);
```

#### **Campos:**
| Campo | Tipo | Nulo | Descri√ß√£o |
|-------|------|------|-----------|
| `id` | VARCHAR(36) | ‚ùå | UUID √∫nico do convidado |
| `user_id` | VARCHAR(36) | ‚ùå | FK para users.id |
| `name` | VARCHAR(255) | ‚ùå | Nome do convidado |
| `email` | VARCHAR(255) | ‚úÖ | Email do convidado |
| `status` | ENUM | ‚ùå | Status do convite |
| `metadata` | JSON | ‚úÖ | Dados adicionais flex√≠veis |
| `created_at` | TIMESTAMP | ‚ùå | Data de cria√ß√£o |
| `updated_at` | TIMESTAMP | ‚ùå | √öltima atualiza√ß√£o |

#### **Status Flow:**
```
pending ‚Üí confirmed
pending ‚Üí cancelled
confirmed ‚Üí cancelled (opcional)
```

### üìã **Audit Logs**
Log de auditoria para rastreamento de a√ß√µes.

```sql
CREATE TABLE audit_logs (
    id VARCHAR(36) PRIMARY KEY DEFAULT (uuid()),
    user_id VARCHAR(36),
    action VARCHAR(255) NOT NULL,
    resource VARCHAR(255) NOT NULL,
    details JSON,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_audit_logs_user_id (user_id),
    INDEX idx_audit_logs_action (action),
    INDEX idx_audit_logs_resource (resource),
    INDEX idx_audit_logs_created_at (created_at)
);
```

#### **Campos:**
| Campo | Tipo | Nulo | Descri√ß√£o |
|-------|------|------|-----------|
| `id` | VARCHAR(36) | ‚ùå | UUID √∫nico do log |
| `user_id` | VARCHAR(36) | ‚úÖ | FK para users.id (pode ser null) |
| `action` | VARCHAR(255) | ‚ùå | A√ß√£o realizada |
| `resource` | VARCHAR(255) | ‚ùå | Recurso afetado |
| `details` | JSON | ‚úÖ | Detalhes adicionais |
| `ip_address` | VARCHAR(45) | ‚úÖ | IP do usu√°rio |
| `user_agent` | TEXT | ‚úÖ | User agent do browser |
| `created_at` | TIMESTAMP | ‚ùå | Timestamp da a√ß√£o |

#### **A√ß√µes T√≠picas:**
- `user.login`, `user.logout`
- `youtube.connect`, `youtube.disconnect`
- `guest.create`, `guest.update`, `guest.delete`
- `token.refresh`, `token.expire`

---

## üîß **PRISMA SCHEMA**

### üìÑ **schema.prisma**
```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // ou "sqlite" para dev
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  googleId  String   @unique @map("google_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  youtubeTokens YouTubeToken[]
  guests        Guest[]
  auditLogs     AuditLog[]

  @@map("users")
  @@index([email])
  @@index([googleId])
}

model YouTubeToken {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  accessToken  String   @map("access_token") @db.Text
  refreshToken String   @map("refresh_token") @db.Text
  expiresAt    DateTime @map("expires_at")
  scope        String   @default("https://www.googleapis.com/auth/youtube.readonly")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel YouTubeChannel?

  @@map("youtube_tokens")
  @@index([userId])
  @@index([expiresAt])
}

model YouTubeChannel {
  id              String   @id @default(uuid())
  tokenId         String   @unique @map("token_id")
  channelId       String   @unique @map("channel_id")
  title           String
  description     String?  @db.Text
  subscriberCount Int      @default(0) @map("subscriber_count")
  videoCount      Int      @default(0) @map("video_count")
  viewCount       BigInt   @default(0) @map("view_count")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  token YouTubeToken @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  @@map("youtube_channels")
  @@index([channelId])
  @@index([updatedAt])
}

model Guest {
  id        String      @id @default(uuid())
  userId    String      @map("user_id")
  name      String
  email     String?
  status    GuestStatus @default(PENDING)
  metadata  Json?
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  // Relacionamentos
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("guests")
  @@index([userId])
  @@index([status])
  @@index([email])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String
  resource  String
  details   Json?
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent") @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  // Relacionamentos
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}

enum GuestStatus {
  PENDING
  CONFIRMED
  CANCELLED
}
```

---

## üìà **OTIMIZA√á√ïES E √çNDICES**

### üöÄ **Estrat√©gia de Indexa√ß√£o**
```sql
-- √çndices principais (j√° na defini√ß√£o das tabelas)
-- √çndices compostos para queries comuns
CREATE INDEX idx_guests_user_status ON guests(user_id, status);
CREATE INDEX idx_audit_logs_user_action ON audit_logs(user_id, action);
CREATE INDEX idx_youtube_tokens_user_expires ON youtube_tokens(user_id, expires_at);

-- √çndices de texto para busca (se necess√°rio)
CREATE INDEX idx_guests_name_text ON guests USING gin(to_tsvector('portuguese', name));
```

### üìä **Query Patterns**
```sql
-- Query mais comum: buscar tokens n√£o expirados
SELECT * FROM youtube_tokens 
WHERE user_id = ? AND expires_at > NOW();

-- Query frequente: convidados por status
SELECT * FROM guests 
WHERE user_id = ? AND status = 'pending' 
ORDER BY created_at DESC;

-- Query de auditoria
SELECT * FROM audit_logs 
WHERE user_id = ? AND action LIKE 'youtube.%' 
ORDER BY created_at DESC LIMIT 50;
```

---

## üîÑ **MIGRA√á√ïES**

### üìã **Estrat√©gia de Migra√ß√£o**
```bash
# Desenvolvimento
npx prisma migrate dev --name init

# Produ√ß√£o
npx prisma migrate deploy

# Reset (apenas dev)
npx prisma migrate reset
```

### üóÉÔ∏è **Backup Strategy**
```bash
# Backup completo
pg_dump sistema_lancei_essa > backup_$(date +%Y%m%d).sql

# Backup apenas schema
pg_dump --schema-only sistema_lancei_essa > schema_backup.sql

# Restore
psql sistema_lancei_essa < backup_20250129.sql
```

---

## üîê **SEGURAN√áA DO BANCO**

### üõ°Ô∏è **Pr√°ticas Implementadas**
- **Encryption at Rest:** Tokens sens√≠veis criptografados
- **Connection Pooling:** Limite de conex√µes configurado
- **Query Validation:** Prisma previne SQL injection
- **Access Control:** Usu√°rio espec√≠fico com permiss√µes limitadas

### üîí **Dados Sens√≠veis**
```javascript
// ‚úÖ BOM - Criptografar antes de salvar
const encryptedToken = encrypt(accessToken, process.env.ENCRYPTION_KEY);
await prisma.youTubeToken.create({
  data: { accessToken: encryptedToken, ... }
});

// ‚ùå RUIM - Nunca salvar em texto plano
await prisma.youTubeToken.create({
  data: { accessToken: plainTextToken, ... }
});
```

---

## üìä **MONITORAMENTO**

### üìà **M√©tricas Importantes**
- **Connection Pool:** Utiliza√ß√£o e timeouts
- **Query Performance:** Tempo m√©dio por query
- **Storage:** Crescimento de dados
- **Backup Status:** Sucesso/falha de backups

### üîç **Queries de Monitoramento**
```sql
-- Tamanho das tabelas
SELECT 
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- Queries mais lentas
SELECT query, mean_time, calls 
FROM pg_stat_statements 
ORDER BY mean_time DESC LIMIT 10;

-- √çndices n√£o utilizados
SELECT schemaname, tablename, indexname, idx_tup_read, idx_tup_fetch
FROM pg_stat_user_indexes 
WHERE idx_tup_read = 0;
```

---

## üîó **LINKS RELACIONADOS**

### üìö **Documenta√ß√£o**
- [Prisma Documentation](https://www.prisma.io/docs)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [API Design](api-design.md)

### üõ†Ô∏è **Ferramentas**
- [Prisma Studio](http://localhost:5555)
- [Database Migrations](../../scripts/migrations/)
- [Backup Scripts](../../scripts/backup/)

---

**üí° Um schema bem documentado √© a base de um sistema confi√°vel e escal√°vel!**
